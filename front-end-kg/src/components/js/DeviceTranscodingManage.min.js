import api from"@/api";export default{data:()=>({dataVal:"",province:"",jurisdictionValue:"",downvendor:"",options:[],options1:[],options2:[],options3:[],activeNames:"",listData:[],cameraList:[],flow:"",isActive:"",temp:!1,dialogVisible:!1,dialogTitle:"",details:!1,orgCodeProps:{expandTrigger:"hover",value:"organizationId",label:"organizationName",children:"childNode"},isState:"",formData:{regionCode:"",organizationName:"",organizationId:"",smId:"",vendorCode:"",vendorName:"",authToken:"",ipAddress:"",responsiblePerson:"",phone:"",channelNum:"",deviceCode:"",deviceUser:""},vendorNameview:"",state:[{name:"在线",code:"1"},{name:"不在线",code:"0"}],fileList:[],modification:!1,transcodingId:"",addAndmodify:"add",currentItem:{},errorDatalist:[],Obj:{regionName:"省份",organizationName:"所属公司",channelNum:"最大接入量",streamName:"所属流媒体",vendorName:"设备厂商",ipAddress:"访问地址",deviceCode:"设备端号",deviceUser:"User",authToken:"设备Token",responsiblePerson:"联系人",phone:"电话"},organizationId:null,cameraListPageSize:10,cameraListCurrentPage:1,cameraListTotal:null}),watch:{dialogVisible(res){res||this.emptyFormData()}},methods:{handleSizeChange(newSize){this.cameraListPageSize=newSize,this.cameraListCurrentPage=1,this.handleChange()},handleCurrentChange(newPage){this.cameraListCurrentPage=newPage,this.handleChange()},removeQuery(){this.province="",this.jurisdictionValue="",this.isState="",this.downvendor="",this.listData=[],this.cameraList=[],this.query()},clearDialogForm(){this.emptyFormData(),this.$refs.Secretupload&&this.$refs.Secretupload.clearFiles(),this.$refs.upload&&this.$refs.upload.clearFiles()},handleCommand(command){this.modification=!1,this.addAndmodify="add",this.vendorNameview="",this.formData.organizationName="",1===command?(this.dialogTitle="新增",this.dialogVisible=!0):2===command&&(this.temp=!0)},uploadFile(file){this.formDate.append("file",file.file)},SecretuploadFile(file){this.formDate.append("file",file.file)},keyuploadChange(id,bute){let formData=new FormData;const file=this.$refs[bute][0].files;formData.append("file",file[0]),this.$http.post("device/transcoding/uploadPrivateKey/"+JSON.stringify(id),formData).then(res=>{"200"==res.data.code?(this.$message({message:"上传成功!",type:"success"}),this.query()):this.$message({message:res.data.message,type:"warning"})})},getagainSecretKey(item){this.transcodingId=item.transcodingId},addData(){this.formDate=new FormData,this.$http.post("/device/transcoding/import",this.formDate).then(res=>{if(res.data.data.error.length)return this.details=!0,this.errorDatalist=res.data.data.error,!1;"200"==res.data.status&&(this.$message({message:res.data.message,type:"success"}),this.$refs.upload.clearFiles())})},copyTXT(obj){if(null!=obj){var textBox=document.createElement("input");textBox.value=obj,document.body.appendChild(textBox),textBox.select(),document.execCommand("copy")&&(document.execCommand("copy"),textBox.className="textBox",textBox.style.display="none",this.$message({message:"复制成功!",type:"success",duration:1e3}))}else this.$message({message:"复制文本为空",type:"warning"})},modificationQquipment(item){this.currentItem=item,this.transcodingId=item.transcodingId,this.addAndmodify="modify",this.dialogTitle="修改",this.dialogVisible=!0,this.modification=!0,this.formData.organizationName=item.organizationName;let regCnameRs=this.fliterData3(this.options,item.regionName);this.formData.regionCode=regCnameRs?regCnameRs.regionCode:"",this.formData.organizationId=item.organizationId;let smCnameRs=this.fliterData(this.options3,item.smName);this.formData.smId=smCnameRs?smCnameRs.smId:"",this.vendorNameview=item.vendorName;let rs2=this.fliterData2(this.options2,item.vendorName);this.formData.vendorCode=rs2?rs2.codeValue:"",this.formData.vendorName=item.vendorName,this.formData.authToken=item.transcodingToken,this.formData.ipAddress=item.ipAddress+(item.port?":"+item.port:""),this.formData.responsiblePerson=item.responsiblePerson,this.formData.phone=item.phone,this.formData.channelNum=item.channelNum,this.formData.deviceCode=item.deviceCode,this.formData.deviceUser=item.deviceUser},emptyFormData(){for(let key in this.formData)this.formData[key]=""},hideFormData(){this.dialogVisible=!1,this.modification=!1,this.$refs.Secretupload.clearFiles(),this.$refs.addForm.resetFields(),this.emptyFormData()},fliterData(data,value){for(let i=0;i<data.length;i++)if(data[i].smName==value)return data[i]},fliterData2(data,value){for(let i=0;i<data.length;i++)if(data[i].codeName==value)return data[i]},fliterData3(data,value){for(let i=0;i<data.length;i++)if(data[i].regionName==value)return data[i]},async query(){var data={provinceCode:this.province,onlineStatus:this.isState,vendorCode:this.downvendor,isVirtual:"0",organizationId:this.organizationId},dta="currPage=1&pageSize=0";const{data:res}=await this.$http.post("/device/transcoding/list?"+dta,data);this.listData=res.data},async handleChange(transcodingId){var dta=`currPage=${this.cameraListCurrentPage}&pageSize=${this.cameraListPageSize}`,data={transcodingId:transcodingId};const{data:res}=await this.$http.post("/device/camera/list?"+dta,data);200!==res.code&&this.$message.error(res.message),this.cameraList=res.data,this.cameraListTotal=res.total},async flowA(status,transcodingId,e){var data="status="+status;const{data:res}=await this.$http.post("/device/transcoding/updateStreamStatus/"+transcodingId+"?"+data);200==res.code?this.$message.success(e.target.innerText+"成功"):this.$message.error(e.target.innerText+"失败")},async flowOpen(status,transcodingId,e){var data="openStatus="+status;const{data:res}=await this.$http.post("/device/transcoding/updateOpenStatus/"+transcodingId+"?"+data);200==res.code?this.$message.success(e.target.innerText+"成功"):this.$message.error(e.target.innerText+"失败")},async play(status,transcodingId,e){var data="playStatus="+status;const{data:res}=await this.$http.post("/device/transcoding/updatePlayStatus/"+transcodingId+"?"+data);200==res.code?this.$message.success(e.target.innerText+"成功"):this.$message.error(e.target.innerText+"失败")},exportCameraList(id){var params={transcodingId:id,onlineStatus:"",organizationCode:"",provinceCode:"",vendorCode:""};api.exportCameraList(params).then(data=>{var blob=new Blob([data],{type:"application/vnd.ms-excel"}),downloadElement=document.createElement("a"),href=window.URL.createObjectURL(blob);downloadElement.href=href,downloadElement.download="摄像机信息表.xlsx",document.body.appendChild(downloadElement),downloadElement.click(),this.$message({message:"导出成功! ",type:"success"}),document.body.removeChild(downloadElement),window.URL.revokeObjectURL(href)}).catch(error=>{this.$message({message:"摄像机导出失败! ",type:"error"})})},async cameraExport(transcodingId){var data={transCodingId:transcodingId};this.$http.post("/device/transcoding/accessorInfo/export?"+`transCodingId=${transcodingId} `,data,{responseType:"arraybuffer"}).then(res=>{var blob=new Blob([res.data],{type:"application/vnd.ms-excel"}),downloadElement=document.createElement("a"),href=window.URL.createObjectURL(blob);downloadElement.href=href,document.body.appendChild(downloadElement),downloadElement.click(),document.body.removeChild(downloadElement),window.URL.revokeObjectURL(href)}).catch((function(error){this.$message.error(error)})),200==res.code?this.$message.success("成功"):this.$message.error("失败")},async dataAdd(){if(!this.formData.regionCode)return this.$notify.error({title:"注意！",message:"请选择省份",duration:1500});if(!this.formData.organizationId)return this.$notify.error({title:"注意！",message:"请选择管辖单位",duration:1500});if(!this.formData.vendorCode)return this.$notify.error({title:"注意！",message:"请选择设备厂商",duration:1500});if(!this.formData.channelNum)return this.$notify.error({title:"注意！",message:"请输入最大接入量",duration:1500});var data=this.formData;if("add"==this.addAndmodify){const{data:res}=await this.$http.post("/device/transcoding/add",data);200===res.code?(this.$message.success("成功"),this.query(),this.formDate=new FormData,this.$http.post("device/transcoding/uploadPrivateKey/"+JSON.stringify(res.data.transcodingId),this.formDate).then(()=>{this.$refs.Secretupload.clearFiles(),this.$refs.addForm.resetFields(),this.emptyFormData(),this.query()}),this.modification=!1):this.$message.error("新增上云网关失败！["+res.code+"]:"+res.message)}else{console.log("修改");let newData={authToken:this.formData.authToken,channelNum:this.formData.channelNum,deviceCode:this.formData.deviceCode,deviceUser:this.formData.deviceUser,ipAddress:this.formData.ipAddress,phone:this.formData.phone,responsiblePerson:this.formData.responsiblePerson,smId:this.formData.smId};this.$http.post("device/transcoding/edit/"+this.transcodingId,newData).then(respon=>{let res=respon.data;200===res.code?(this.$message.success("修改成功!"),this.$refs.Secretupload.clearFiles(),this.$refs.addForm.resetFields(),this.emptyFormData(),this.query()):this.$message.error("编辑上云网关失败！["+res.code+"]:"+res.message)})}this.dialogVisible=!1},delData(transcodingId){this.$confirm("提示",{title:"提示",message:"确定删除上云网关信息吗？",showCancelButton:!0,confirmButtonText:"确定",cancelButtonText:"取消"}).then(()=>{this.$http.delete("/device/transcoding/"+transcodingId).then(res=>{200==res.data.code?(this.$message.success("删除成功"),this.query()):this.$message.error(`${res.data.message}`)})})},async downProvince(){const{data:res}=await this.$http.get("/basic/region/0");this.options=res.data},async downDw(){const{data:res}=await this.$http.get("/org/orgTree");let newarr=[];this.treecl(res.data),this.options1=res.data},organizationNameChange(val){val&&(console.log(val,"jidj"),this.formData.organizationId=val[val.length-1],this.organizationId=val[val.length-1])},closeHandleChange(visible){},async downVendor(){const{data:res}=await this.$http.get("/basic/codemaster/VENDOR ");this.options2=res.data},vendorCodeChange(res){console.log(res,"jidj"),this.formData.vendorName=res.split("*")[0],this.formData.vendorCode=res.split("*")[1]},async getStreamingMedia(){const{data:res}=await this.$http.post("/sm/pages",{currPage:0,pageSize:0});this.options3=res.data.list},download(){this.$http.get("/device/transcoding/downTemplate",{responseType:"blob"}).then((function(res){if(!res)return;let blob=new Blob([res.data],{type:"application/vnd.ms-excel;charset=utf-8"}),url=window.URL.createObjectURL(blob),aLink=document.createElement("a");aLink.style.display="none",aLink.href=url,aLink.setAttribute("download","视频上云网关信息表.xls"),document.body.appendChild(aLink),aLink.click(),document.body.removeChild(aLink),window.URL.revokeObjectURL(url)})).catch((function(error){}))},treecl(data){for(let i in data)data[i].value=data[i].organizationName+"*"+data[i].organizationId,data[i].childNode,this.treecl(data[i].childNode)}},created(){this.query(),this.downProvince(),this.downDw(),this.downVendor(),this.getStreamingMedia()}};